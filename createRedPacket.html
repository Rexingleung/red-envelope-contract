<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>çº¢åŒ…åˆçº¦éªŒè¯å·¥å…·</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .header h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 2.5rem;
        }
        
        .header p {
            color: #666;
            font-size: 1.1rem;
        }
        
        .verification-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #007bff;
        }
        
        .verification-section h3 {
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .input-group {
            margin-bottom: 15px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }
        
        .input-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        .input-group input:focus {
            outline: none;
            border-color: #007bff;
        }
        
        .btn {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: transform 0.2s, box-shadow 0.2s;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,123,255,0.4);
        }
        
        .btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-success {
            background: linear-gradient(135deg, #28a745, #1e7e34);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #dc3545, #a71e2a);
        }
        
        .result-area {
            margin-top: 20px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border: 1px solid #dee2e6;
            min-height: 150px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            font-size: 14px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .status {
            padding: 8px 12px;
            border-radius: 4px;
            font-weight: 600;
            margin-bottom: 10px;
            display: inline-block;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .network-status {
            text-align: center;
            margin-bottom: 20px;
            padding: 10px;
            background: #e3f2fd;
            border-radius: 8px;
        }
        
        .function-test {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ§§ çº¢åŒ…åˆçº¦éªŒè¯å·¥å…·</h1>
            <p>Sepolia æµ‹è¯•ç½‘æ™ºèƒ½åˆçº¦éªŒè¯ä¸æµ‹è¯•</p>
        </div>
        
        <div class="network-status">
            <div id="networkStatus">ğŸ”— æ£€æŸ¥ç½‘ç»œè¿æ¥ä¸­...</div>
        </div>
        
        <div class="verification-section">
            <h3>ğŸ“‹ åˆçº¦åŸºæœ¬ä¿¡æ¯</h3>
            <div class="input-group">
                <label for="contractAddress">åˆçº¦åœ°å€:</label>
                <input type="text" id="contractAddress" placeholder="0x..." />
            </div>
            <button class="btn" onclick="verifyContract()">éªŒè¯åˆçº¦</button>
            <div id="contractResult" class="result-area"></div>
        </div>
        
        <div class="verification-section">
            <h3>ğŸ” åˆçº¦åŠŸèƒ½æµ‹è¯•</h3>
            <div class="function-test">
                <button class="btn btn-success" onclick="testReadFunctions()">æµ‹è¯•è¯»å–åŠŸèƒ½</button>
                <button class="btn" onclick="connectWallet()">è¿æ¥é’±åŒ…</button>
                <button class="btn" onclick="testCreatePacket()" id="createBtn" disabled>åˆ›å»ºçº¢åŒ…</button>
                <button class="btn" onclick="testClaimPacket()" id="claimBtn" disabled>æŠ¢çº¢åŒ…</button>
            </div>
            <div class="input-group">
                <label for="packetCount">çº¢åŒ…æ•°é‡:</label>
                <input type="number" id="packetCount" value="3" min="1" max="10" />
            </div>
            <div class="input-group">
                <label for="packetAmount">çº¢åŒ…æ€»é‡‘é¢ (ETH):</label>
                <input type="number" id="packetAmount" value="0.003" step="0.001" min="0.001" />
            </div>
            <div class="input-group">
                <label for="packetId">çº¢åŒ…ID (ç”¨äºæŠ¢çº¢åŒ…):</label>
                <input type="number" id="packetId" value="0" min="0" />
            </div>
            <div id="functionResult" class="result-area"></div>
        </div>
        
        <div class="verification-section">
            <h3>ğŸ“Š äº‹ä»¶æ—¥å¿—æŸ¥è¯¢</h3>
            <button class="btn" onclick="queryEvents()">æŸ¥è¯¢äº‹ä»¶</button>
            <div id="eventResult" class="result-area"></div>
        </div>
    </div>

    <script>
        let provider;
        let signer;
        let contract;
        let userAddress;
        
        const CONTRACT_ABI = [
            "function createRedPacket(uint256 _count) external payable",
            "function claimRedPacket(uint256 _packetId) external",
            "function refundRedPacket(uint256 _packetId) external",
            "function getPacketInfo(uint256 _packetId) external view returns (address, uint256, uint256, uint256, uint256, bool)",
            "function hasClaimed(uint256 _packetId, address _user) external view returns (bool)",
            "function getCurrentPacketId() external view returns (uint256)",
            "event PacketCreated(uint256 indexed packetId, address indexed sender, uint256 totalAmount, uint256 totalCount)",
            "event PacketClaimed(uint256 indexed packetId, address indexed claimer, uint256 amount)",
            "event PacketRefunded(uint256 indexed packetId, address indexed sender, uint256 refundAmount)"
        ];
        
        // åˆå§‹åŒ–
        async function init() {
            try {
                if (typeof window.ethereum !== 'undefined') {
                    provider = new ethers.providers.Web3Provider(window.ethereum);
                    updateNetworkStatus('âœ… MetaMask å·²è¿æ¥');
                } else {
                    provider = new ethers.providers.JsonRpcProvider('https://sepolia.infura.io/v3/9aa3d95b3bc440fa88ea12eaa4456161');
                    updateNetworkStatus('âš ï¸ ä½¿ç”¨å…¬å…± RPC (ä»…é™åªè¯»æ“ä½œ)');
                }
                
                const network = await provider.getNetwork();
                if (network.chainId === 11155111) {
                    updateNetworkStatus('âœ… å·²è¿æ¥åˆ° Sepolia æµ‹è¯•ç½‘');
                } else {
                    updateNetworkStatus('âŒ è¯·åˆ‡æ¢åˆ° Sepolia æµ‹è¯•ç½‘');
                }
            } catch (error) {
                updateNetworkStatus('âŒ ç½‘ç»œè¿æ¥å¤±è´¥: ' + error.message);
            }
        }
        
        function updateNetworkStatus(message) {
            document.getElementById('networkStatus').textContent = message;
        }
        
        function log(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            const statusClass = type === 'error' ? 'error' : type === 'success' ? 'success' : 'warning';
            const statusIcon = type === 'error' ? 'âŒ' : type === 'success' ? 'âœ…' : 'â„¹ï¸';
            
            element.innerHTML += `<div class="status ${statusClass}">${statusIcon} ${timestamp}</div>\n${message}\n\n`;
            element.scrollTop = element.scrollHeight;
        }
        
        async function verifyContract() {
            const address = document.getElementById('contractAddress').value;
            if (!address) {
                alert('è¯·è¾“å…¥åˆçº¦åœ°å€');
                return;
            }
            
            log('contractResult', 'å¼€å§‹éªŒè¯åˆçº¦...', 'info');
            
            try {
                // æ£€æŸ¥åˆçº¦ä»£ç 
                const code = await provider.getCode(address);
                if (code === '0x') {
                    log('contractResult', 'åˆçº¦ä¸å­˜åœ¨æˆ–æœªéƒ¨ç½²', 'error');
                    return;
                }
                
                log('contractResult', 'âœ… åˆçº¦ä»£ç éªŒè¯é€šè¿‡', 'success');
                
                // åˆ›å»ºåˆçº¦å®ä¾‹
                contract = new ethers.Contract(address, CONTRACT_ABI, provider);
                
                // æµ‹è¯•åŸºæœ¬åŠŸèƒ½
                const currentId = await contract.getCurrentPacketId();
                log('contractResult', `å½“å‰çº¢åŒ…ID: ${currentId}`, 'success');
                
                if (currentId.gt(0)) {
                    try {
                        const packetInfo = await contract.getPacketInfo(0);
                        log('contractResult', `çº¢åŒ…ä¿¡æ¯è¯»å–æˆåŠŸ:\nå‘é€è€…: ${packetInfo[0]}\næ€»é‡‘é¢: ${ethers.utils.formatEther(packetInfo[1])} ETH\nå‰©ä½™é‡‘é¢: ${ethers.utils.formatEther(packetInfo[2])} ETH\næ€»æ•°é‡: ${packetInfo[3]}\nå‰©ä½™æ•°é‡: ${packetInfo[4]}\næ˜¯å¦æ¿€æ´»: ${packetInfo[5]}`, 'success');
                    } catch (error) {
                        log('contractResult', `æ— æ³•è¯»å–çº¢åŒ… 0 çš„ä¿¡æ¯: ${error.message}`, 'warning');
                    }
                }
                
                log('contractResult', 'ğŸ‰ åˆçº¦éªŒè¯å®Œæˆï¼', 'success');
                
            } catch (error) {
                log('contractResult', `éªŒè¯å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        async function connectWallet() {
            try {
                if (typeof window.ethereum === 'undefined') {
                    alert('è¯·å®‰è£… MetaMask');
                    return;
                }
                
                await window.ethereum.request({ method: 'eth_requestAccounts' });
                signer = provider.getSigner();
                userAddress = await signer.getAddress();
                
                log('functionResult', `é’±åŒ…è¿æ¥æˆåŠŸ: ${userAddress}`, 'success');
                
                document.getElementById('createBtn').disabled = false;
                document.getElementById('claimBtn').disabled = false;
                
            } catch (error) {
                log('functionResult', `é’±åŒ…è¿æ¥å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        async function testReadFunctions() {
            const address = document.getElementById('contractAddress').value;
            if (!address) {
                alert('è¯·å…ˆè¾“å…¥åˆçº¦åœ°å€');
                return;
            }
            
            try {
                const testContract = new ethers.Contract(address, CONTRACT_ABI, provider);
                
                log('functionResult', 'æµ‹è¯•åªè¯»åŠŸèƒ½...', 'info');
                
                const currentId = await testContract.getCurrentPacketId();
                log('functionResult', `âœ… getCurrentPacketId(): ${currentId}`, 'success');
                
                if (currentId.gt(0)) {
                    const packetInfo = await testContract.getPacketInfo(0);
                    log('functionResult', `âœ… getPacketInfo(0): æˆåŠŸè¯»å–`, 'success');
                    
                    if (userAddress) {
                        const claimed = await testContract.hasClaimed(0, userAddress);
                        log('functionResult', `âœ… hasClaimed(0, ${userAddress}): ${claimed}`, 'success');
                    }
                }
                
            } catch (error) {
                log('functionResult', `è¯»å–åŠŸèƒ½æµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        async function testCreatePacket() {
            if (!signer || !contract) {
                alert('è¯·å…ˆè¿æ¥é’±åŒ…å¹¶éªŒè¯åˆçº¦');
                return;
            }
            
            const count = document.getElementById('packetCount').value;
            const amount = document.getElementById('packetAmount').value;
            
            try {
                log('functionResult', `åˆ›å»ºçº¢åŒ…: ${count}ä¸ª, æ€»é¢${amount}ETH`, 'info');
                
                const contractWithSigner = contract.connect(signer);
                const tx = await contractWithSigner.createRedPacket(count, {
                    value: ethers.utils.parseEther(amount),
                    gasLimit: 200000
                });
                
                log('functionResult', `äº¤æ˜“å·²å‘é€: ${tx.hash}`, 'info');
                
                const receipt = await tx.wait();
                log('functionResult', `âœ… çº¢åŒ…åˆ›å»ºæˆåŠŸ! Gasä½¿ç”¨: ${receipt.gasUsed}`, 'success');
                
                // æ›´æ–°å½“å‰çº¢åŒ…ID
                const currentId = await contract.getCurrentPacketId();
                document.getElementById('packetId').value = currentId - 1;
                
            } catch (error) {
                log('functionResult', `åˆ›å»ºçº¢åŒ…å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        async function testClaimPacket() {
            if (!signer || !contract) {
                alert('è¯·å…ˆè¿æ¥é’±åŒ…å¹¶éªŒè¯åˆçº¦');
                return;
            }
            
            const packetId = document.getElementById('packetId').value;
            
            try {
                log('functionResult', `å°è¯•æŠ¢çº¢åŒ… ID: ${packetId}`, 'info');
                
                const contractWithSigner = contract.connect(signer);
                const tx = await contractWithSigner.claimRedPacket(packetId, {
                    gasLimit: 150000
                });
                
                log('functionResult', `äº¤æ˜“å·²å‘é€: ${tx.hash}`, 'info');
                
                const receipt = await tx.wait();
                log('functionResult', `âœ… çº¢åŒ…é¢†å–æˆåŠŸ! Gasä½¿ç”¨: ${receipt.gasUsed}`, 'success');
                
            } catch (error) {
                log('functionResult', `é¢†å–çº¢åŒ…å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        async function queryEvents() {
            const address = document.getElementById('contractAddress').value;
            if (!address) {
                alert('è¯·å…ˆè¾“å…¥åˆçº¦åœ°å€');
                return;
            }
            
            try {
                const testContract = new ethers.Contract(address, CONTRACT_ABI, provider);
                
                log('eventResult', 'æŸ¥è¯¢äº‹ä»¶æ—¥å¿—...', 'info');
                
                // æŸ¥è¯¢ PacketCreated äº‹ä»¶
                const createdFilter = testContract.filters.PacketCreated();
                const createdEvents = await testContract.queryFilter(createdFilter, -1000);
                log('eventResult', `PacketCreated äº‹ä»¶: ${createdEvents.length} ä¸ª`, 'success');
                
                createdEvents.forEach((event, index) => {
                    const { packetId, sender, totalAmount, totalCount } = event.args;
                    log('eventResult', `  ${index + 1}. çº¢åŒ…ID:${packetId}, å‘é€è€…:${sender}, é‡‘é¢:${ethers.utils.formatEther(totalAmount)}ETH, æ•°é‡:${totalCount}`, 'info');
                });
                
                // æŸ¥è¯¢ PacketClaimed äº‹ä»¶
                const claimedFilter = testContract.filters.PacketClaimed();
                const claimedEvents = await testContract.queryFilter(claimedFilter, -1000);
                log('eventResult', `PacketClaimed äº‹ä»¶: ${claimedEvents.length} ä¸ª`, 'success');
                
                claimedEvents.forEach((event, index) => {
                    const { packetId, claimer, amount } = event.args;
                    log('eventResult', `  ${index + 1}. çº¢åŒ…ID:${packetId}, é¢†å–è€…:${claimer}, é‡‘é¢:${ethers.utils.formatEther(amount)}ETH`, 'info');
                });
                
            } catch (error) {
                log('eventResult', `æŸ¥è¯¢äº‹ä»¶å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('load', init);
    </script>
</body>
</html>