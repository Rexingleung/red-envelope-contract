<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ’° çº¢åŒ…é€€æ¬¾å·¥å…·</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .header h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 2.5rem;
        }
        
        .header p {
            color: #666;
            font-size: 1.1rem;
        }
        
        .section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #dc3545;
        }
        
        .section h3 {
            color: #333;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .input-group {
            margin-bottom: 15px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }
        
        .input-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        .input-group input:focus {
            outline: none;
            border-color: #dc3545;
        }
        
        .btn {
            background: linear-gradient(135deg, #dc3545, #a71e2a);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(220, 53, 69, 0.4);
        }
        
        .btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .btn-success {
            background: linear-gradient(135deg, #28a745, #1e7e34);
        }
        
        .btn-info {
            background: linear-gradient(135deg, #17a2b8, #117a8b);
        }
        
        .result-area {
            margin-top: 15px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border: 1px solid #dee2e6;
            min-height: 150px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            font-size: 14px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .packet-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            border: 1px solid #dee2e6;
            transition: all 0.3s;
        }
        
        .packet-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .packet-card.refundable {
            border-left: 4px solid #28a745;
        }
        
        .packet-card.empty {
            border-left: 4px solid #6c757d;
            opacity: 0.7;
        }
        
        .packet-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .info-item {
            text-align: center;
        }
        
        .info-label {
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }
        
        .info-value {
            font-size: 18px;
            font-weight: 600;
            color: #333;
        }
        
        .status {
            padding: 8px 12px;
            border-radius: 4px;
            font-weight: 600;
            margin-bottom: 10px;
            display: inline-block;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #dc3545;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .network-status {
            text-align: center;
            margin-bottom: 20px;
            padding: 10px;
            background: #e3f2fd;
            border-radius: 8px;
        }
        
        .warning-box {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .warning-box h4 {
            color: #856404;
            margin-bottom: 10px;
        }
        
        .warning-box ul {
            color: #856404;
            margin-left: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ’° çº¢åŒ…é€€æ¬¾å·¥å…·</h1>
            <p>ç®¡ç†å’Œé€€è¿˜æœªæŠ¢å®Œçš„çº¢åŒ…ä½™é¢</p>
        </div>
        
        <div class="network-status">
            <div id="networkStatus">ğŸ”— æ£€æŸ¥ç½‘ç»œè¿æ¥ä¸­...</div>
        </div>
        
        <div class="warning-box">
            <h4>âš ï¸ é‡è¦æé†’</h4>
            <ul>
                <li>åªæœ‰çº¢åŒ…åˆ›å»ºè€…å¯ä»¥æ‰§è¡Œé€€æ¬¾æ“ä½œ</li>
                <li>é€€æ¬¾åçº¢åŒ…ç«‹å³å¤±æ•ˆï¼Œå…¶ä»–äººæ— æ³•å†æŠ¢</li>
                <li>é€€æ¬¾æ“ä½œéœ€è¦æ”¯ä»˜ Gas è´¹ç”¨ï¼ˆçº¦ 0.001-0.003 ETHï¼‰</li>
                <li>å·²è¢«æŠ¢å®Œçš„çº¢åŒ…æ— æ³•é€€æ¬¾</li>
            </ul>
        </div>
        
        <div class="section">
            <h3>ğŸ”§ è¿æ¥åˆçº¦</h3>
            <div class="input-group">
                <label for="contractAddress">åˆçº¦åœ°å€:</label>
                <input type="text" id="contractAddress" placeholder="0x..." />
            </div>
            <button class="btn btn-info" onclick="connectContract()">è¿æ¥åˆçº¦</button>
            <button class="btn btn-success" onclick="connectWallet()">è¿æ¥é’±åŒ…</button>
            <div id="contractResult" class="result-area"></div>
        </div>
        
        <div class="section">
            <h3>ğŸ“‹ æˆ‘çš„çº¢åŒ…åˆ—è¡¨</h3>
            <button class="btn btn-info" onclick="loadMyPackets()" id="loadBtn" disabled>åŠ è½½æˆ‘çš„çº¢åŒ…</button>
            <button class="btn btn-info" onclick="refreshPackets()">åˆ·æ–°çŠ¶æ€</button>
            <div id="packetsList"></div>
        </div>
        
        <div class="section">
            <h3>ğŸ’¸ æ‰¹é‡é€€æ¬¾</h3>
            <p style="margin-bottom: 15px; color: #666;">ä¸€é”®é€€è¿˜æ‰€æœ‰å¯é€€æ¬¾çš„çº¢åŒ…</p>
            <button class="btn" onclick="batchRefund()" id="batchRefundBtn" disabled>æ‰¹é‡é€€æ¬¾æ‰€æœ‰çº¢åŒ…</button>
            <div id="batchResult" class="result-area"></div>
        </div>
    </div>

    <script>
        let provider;
        let signer;
        let contract;
        let userAddress;
        let myPackets = [];
        
        const CONTRACT_ABI = [
            "function createRedPacket(uint256 _count) external payable",
            "function claimRedPacket(uint256 _packetId) external",
            "function refundRedPacket(uint256 _packetId) external",
            "function getPacketInfo(uint256 _packetId) external view returns (address, uint256, uint256, uint256, uint256, bool)",
            "function hasClaimed(uint256 _packetId, address _user) external view returns (bool)",
            "function getCurrentPacketId() external view returns (uint256)",
            "event PacketCreated(uint256 indexed packetId, address indexed sender, uint256 totalAmount, uint256 totalCount)",
            "event PacketClaimed(uint256 indexed packetId, address indexed claimer, uint256 amount)",
            "event PacketRefunded(uint256 indexed packetId, address indexed sender, uint256 refundAmount)"
        ];
        
        // åˆå§‹åŒ–
        async function init() {
            try {
                if (typeof window.ethereum !== 'undefined') {
                    provider = new ethers.providers.Web3Provider(window.ethereum);
                    updateNetworkStatus('âœ… MetaMask å·²æ£€æµ‹åˆ°');
                } else {
                    provider = new ethers.providers.JsonRpcProvider('https://sepolia.infura.io/v3/9aa3d95b3bc440fa88ea12eaa4456161');
                    updateNetworkStatus('âš ï¸ ä½¿ç”¨å…¬å…± RPC (ä»…é™åªè¯»æ“ä½œ)');
                }
                
                const network = await provider.getNetwork();
                if (network.chainId === 11155111) {
                    updateNetworkStatus('âœ… å·²è¿æ¥åˆ° Sepolia æµ‹è¯•ç½‘');
                } else {
                    updateNetworkStatus('âŒ è¯·åˆ‡æ¢åˆ° Sepolia æµ‹è¯•ç½‘');
                }
            } catch (error) {
                updateNetworkStatus('âŒ ç½‘ç»œè¿æ¥å¤±è´¥: ' + error.message);
            }
        }
        
        function updateNetworkStatus(message) {
            document.getElementById('networkStatus').textContent = message;
        }
        
        function log(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const timestamp = new Date().toLocaleTimeString();
            const statusClass = type === 'error' ? 'error' : type === 'success' ? 'success' : 'warning';
            const statusIcon = type === 'error' ? 'âŒ' : type === 'success' ? 'âœ…' : 'â„¹ï¸';
            
            element.innerHTML += `<div class="status ${statusClass}">${statusIcon} ${timestamp}</div>\n${message}\n\n`;
            element.scrollTop = element.scrollHeight;
        }
        
        async function connectContract() {
            const address = document.getElementById('contractAddress').value;
            if (!address) {
                alert('è¯·è¾“å…¥åˆçº¦åœ°å€');
                return;
            }
            
            log('contractResult', 'è¿æ¥åˆçº¦...', 'info');
            
            try {
                const code = await provider.getCode(address);
                if (code === '0x') {
                    log('contractResult', 'åˆçº¦ä¸å­˜åœ¨æˆ–æœªéƒ¨ç½²', 'error');
                    return;
                }
                
                contract = new ethers.Contract(address, CONTRACT_ABI, provider);
                
                // æµ‹è¯•åˆçº¦åŠŸèƒ½
                const currentId = await contract.getCurrentPacketId();
                log('contractResult', `âœ… åˆçº¦è¿æ¥æˆåŠŸï¼\nå½“å‰çº¢åŒ…æ•°é‡: ${currentId}`, 'success');
                
                document.getElementById('loadBtn').disabled = false;
                
            } catch (error) {
                log('contractResult', `è¿æ¥å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        async function connectWallet() {
            try {
                if (typeof window.ethereum === 'undefined') {
                    alert('è¯·å®‰è£… MetaMask');
                    return;
                }
                
                await window.ethereum.request({ method: 'eth_requestAccounts' });
                signer = provider.getSigner();
                userAddress = await signer.getAddress();
                
                log('contractResult', `é’±åŒ…è¿æ¥æˆåŠŸ: ${userAddress}`, 'success');
                document.getElementById('batchRefundBtn').disabled = false;
                
            } catch (error) {
                log('contractResult', `é’±åŒ…è¿æ¥å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        async function loadMyPackets() {
            if (!contract || !userAddress) {
                alert('è¯·å…ˆè¿æ¥åˆçº¦å’Œé’±åŒ…');
                return;
            }
            
            try {
                log('contractResult', 'æŸ¥æ‰¾ä½ åˆ›å»ºçš„çº¢åŒ…...', 'info');
                
                const currentId = await contract.getCurrentPacketId();
                myPackets = [];
                
                // æŸ¥è¯¢ PacketCreated äº‹ä»¶æ‰¾åˆ°ç”¨æˆ·çš„çº¢åŒ…
                const filter = contract.filters.PacketCreated(null, userAddress);
                const events = await contract.queryFilter(filter, -10000); // æŸ¥è¯¢æœ€è¿‘10000ä¸ªåŒºå—
                
                log('contractResult', `æ‰¾åˆ° ${events.length} ä¸ªä½ åˆ›å»ºçš„çº¢åŒ…`, 'success');
                
                for (let event of events) {
                    const packetId = event.args.packetId.toNumber();
                    try {
                        const packetInfo = await contract.getPacketInfo(packetId);
                        myPackets.push({
                            id: packetId,
                            sender: packetInfo[0],
                            totalAmount: packetInfo[1],
                            remainingAmount: packetInfo[2],
                            totalCount: packetInfo[3].toNumber(),
                            remainingCount: packetInfo[4].toNumber(),
                            isActive: packetInfo[5]
                        });
                    } catch (error) {
                        console.error(`æ— æ³•è·å–çº¢åŒ… ${packetId} ä¿¡æ¯:`, error);
                    }
                }
                
                displayPackets();
                
            } catch (error) {
                log('contractResult', `åŠ è½½å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        function displayPackets() {
            const packetsList = document.getElementById('packetsList');
            
            if (myPackets.length === 0) {
                packetsList.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">æ²¡æœ‰æ‰¾åˆ°ä½ åˆ›å»ºçš„çº¢åŒ…</p>';
                return;
            }
            
            let html = '';
            let refundableCount = 0;
            let totalRefundable = ethers.BigNumber.from(0);
            
            myPackets.forEach(packet => {
                const isRefundable = packet.isActive && packet.remainingAmount.gt(0);
                if (isRefundable) {
                    refundableCount++;
                    totalRefundable = totalRefundable.add(packet.remainingAmount);
                }
                
                html += `
                    <div class="packet-card ${isRefundable ? 'refundable' : 'empty'}">
                        <div class="packet-info">
                            <div class="info-item">
                                <div class="info-label">çº¢åŒ…ID</div>
                                <div class="info-value">${packet.id}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">æ€»é‡‘é¢</div>
                                <div class="info-value">${ethers.utils.formatEther(packet.totalAmount)} ETH</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">å‰©ä½™é‡‘é¢</div>
                                <div class="info-value" style="color: ${packet.remainingAmount.gt(0) ? '#28a745' : '#6c757d'}">${ethers.utils.formatEther(packet.remainingAmount)} ETH</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">å‰©ä½™æ•°é‡</div>
                                <div class="info-value">${packet.remainingCount}/${packet.totalCount}</div>
                            </div>
                            <div class="info-item">
                                <div class="info-label">çŠ¶æ€</div>
                                <div class="info-value" style="color: ${packet.isActive ? '#28a745' : '#6c757d'}">${packet.isActive ? 'æ¿€æ´»' : 'å·²ç»“æŸ'}</div>
                            </div>
                        </div>
                        <div style="text-align: center;">
                            ${isRefundable ? 
                                `<button class="btn" onclick="refundSinglePacket(${packet.id})">é€€æ¬¾æ­¤çº¢åŒ…</button>` : 
                                `<span style="color: #6c757d;">æ— æ³•é€€æ¬¾</span>`
                            }
                        </div>
                    </div>
                `;
            });
            
            // æ·»åŠ æ±‡æ€»ä¿¡æ¯
            if (refundableCount > 0) {
                html = `
                    <div style="background: #d4edda; border: 1px solid #c3e6cb; border-radius: 8px; padding: 15px; margin-bottom: 20px; text-align: center;">
                        <h4 style="color: #155724; margin-bottom: 10px;">ğŸ’° å¯é€€æ¬¾æ±‡æ€»</h4>
                        <p style="color: #155724; margin: 0;">
                            <strong>${refundableCount} ä¸ªçº¢åŒ…</strong> å¯é€€æ¬¾ï¼Œæ€»è®¡ <strong>${ethers.utils.formatEther(totalRefundable)} ETH</strong>
                        </p>
                    </div>
                ` + html;
            }
            
            packetsList.innerHTML = html;
        }
        
        async function refundSinglePacket(packetId) {
            if (!signer || !contract) {
                alert('è¯·å…ˆè¿æ¥é’±åŒ…');
                return;
            }
            
            try {
                log('contractResult', `å¼€å§‹é€€æ¬¾çº¢åŒ… ID: ${packetId}`, 'info');
                
                const contractWithSigner = contract.connect(signer);
                const tx = await contractWithSigner.refundRedPacket(packetId, {
                    gasLimit: 100000
                });
                
                log('contractResult', `é€€æ¬¾äº¤æ˜“å·²å‘é€: ${tx.hash}`, 'info');
                
                const receipt = await tx.wait();
                
                // ä»äº‹ä»¶ä¸­è·å–é€€æ¬¾é‡‘é¢
                const refundEvent = receipt.events.find(e => e.event === 'PacketRefunded');
                if (refundEvent) {
                    const amount = ethers.utils.formatEther(refundEvent.args.refundAmount);
                    log('contractResult', `âœ… çº¢åŒ… ${packetId} é€€æ¬¾æˆåŠŸï¼\né€€æ¬¾é‡‘é¢: ${amount} ETH\nGas ä½¿ç”¨: ${receipt.gasUsed}`, 'success');
                }
                
                // åˆ·æ–°æ•°æ®
                setTimeout(() => {
                    refreshPackets();
                }, 2000);
                
            } catch (error) {
                let errorMsg = error.message;
                if (errorMsg.includes('OnlySenderCanRefund')) {
                    errorMsg = 'åªæœ‰çº¢åŒ…åˆ›å»ºè€…å¯ä»¥é€€æ¬¾';
                } else if (errorMsg.includes('PacketNotActive')) {
                    errorMsg = 'çº¢åŒ…å·²ç»“æŸæˆ–å·²è¢«æŠ¢å®Œ';
                }
                log('contractResult', `çº¢åŒ… ${packetId} é€€æ¬¾å¤±è´¥: ${errorMsg}`, 'error');
            }
        }
        
        async function batchRefund() {
            if (!signer || !contract || myPackets.length === 0) {
                alert('è¯·å…ˆè¿æ¥é’±åŒ…å¹¶åŠ è½½çº¢åŒ…åˆ—è¡¨');
                return;
            }
            
            const refundablePackets = myPackets.filter(packet => 
                packet.isActive && packet.remainingAmount.gt(0)
            );
            
            if (refundablePackets.length === 0) {
                alert('æ²¡æœ‰å¯é€€æ¬¾çš„çº¢åŒ…');
                return;
            }
            
            if (!confirm(`ç¡®å®šè¦é€€æ¬¾ ${refundablePackets.length} ä¸ªçº¢åŒ…å—ï¼Ÿ\næ³¨æ„ï¼šæ¯ä¸ªçº¢åŒ…éƒ½éœ€è¦å•ç‹¬çš„ Gas è´¹ç”¨`)) {
                return;
            }
            
            log('batchResult', `å¼€å§‹æ‰¹é‡é€€æ¬¾ ${refundablePackets.length} ä¸ªçº¢åŒ…...`, 'info');
            
            let successCount = 0;
            let totalRefunded = ethers.BigNumber.from(0);
            const contractWithSigner = contract.connect(signer);
            
            for (let i = 0; i < refundablePackets.length; i++) {
                const packet = refundablePackets[i];
                
                try {
                    log('batchResult', `[${i+1}/${refundablePackets.length}] é€€æ¬¾çº¢åŒ… ${packet.id}...`, 'info');
                    
                    const tx = await contractWithSigner.refundRedPacket(packet.id, {
                        gasLimit: 100000
                    });
                    
                    const receipt = await tx.wait();
                    const refundEvent = receipt.events.find(e => e.event === 'PacketRefunded');
                    
                    if (refundEvent) {
                        const amount = refundEvent.args.refundAmount;
                        totalRefunded = totalRefunded.add(amount);
                        successCount++;
                        
                        log('batchResult', `âœ… çº¢åŒ… ${packet.id} é€€æ¬¾æˆåŠŸ: ${ethers.utils.formatEther(amount)} ETH`, 'success');
                    }
                    
                    // æ¯ä¸ªäº¤æ˜“é—´éš”1ç§’ï¼Œé¿å…ç½‘ç»œæ‹¥å µ
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    
                } catch (error) {
                    log('batchResult', `âŒ çº¢åŒ… ${packet.id} é€€æ¬¾å¤±è´¥: ${error.message}`, 'error');
                }
            }
            
            log('batchResult', `\nğŸ‰ æ‰¹é‡é€€æ¬¾å®Œæˆï¼\næˆåŠŸé€€æ¬¾: ${successCount}/${refundablePackets.length} ä¸ªçº¢åŒ…\næ€»é€€æ¬¾é‡‘é¢: ${ethers.utils.formatEther(totalRefunded)} ETH`, 'success');
            
            // åˆ·æ–°æ•°æ®
            setTimeout(() => {
                refreshPackets();
            }, 3000);
        }
        
        async function refreshPackets() {
            if (myPackets.length > 0) {
                await loadMyPackets();
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('load', init);
    </script>
</body>
</html>